{% extends "base.html" %}
{% block content %}
<div class="container py-4">
  <h4>{{ 'Editar orden #' ~ order.id if order else 'Nueva orden' }}</h4>
  <form id="orderForm" method="post" novalidate>
    <div class="row g-3">

      <!-- CLIENTE -->
      <div class="col-md-6">
        <label class="form-label">Cliente *</label>
        <div class="input-group">
          <select class="form-select" name="client_id" id="client_id" required>
            <option value="">Seleccione...</option>
            {% for c in clients %}
            <option value="{{ c.id }}" {% if order and order.client_id==c.id %}selected{% endif %}>{{ c.nombre }}</option>
            {% endfor %}
          </select>
          <button
            type="button"
            class="btn btn-outline-secondary"
            id="btnBuscarCliente"
            data-bs-toggle="modal"
            data-bs-target="#clientModal"
            title="Buscar cliente"
          >
            üîç
          </button>
        </div>
      </div>

      <!-- ESTADO INICIAL -->
      <div class="col-md-3">
        <label class="form-label">Estado inicial</label>
        <select class="form-select" name="estado" {% if order %}disabled{% endif %}>
          {% for val, label in estados %}
            <option value="{{ val }}" {% if order and order.estado==val %}selected{% endif %}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>

      <!-- IMEI NUM√âRICO Y HASTA 15 -->
      <div class="col-md-3">
        <label class="form-label">IMEI</label>
        <input
          class="form-control"
          id="imei"
          name="imei"
          maxlength="15"
          value="{{ order.imei if order else '' }}"
          inputmode="numeric"
          pattern="\\d{0,15}"
          title="Solo n√∫meros, m√°ximo 15 d√≠gitos"
        >
      </div>

      <!-- CAMPOS REQUERIDOS -->
      <div class="col-md-3">
        <label class="form-label">Marca *</label>
        <input class="form-control" name="marca" id="marca" value="{{ order.marca if order else '' }}" required>
      </div>

      <div class="col-md-3">
        <label class="form-label">Modelo *</label>
        <input class="form-control" name="modelo" id="modelo" value="{{ order.modelo if order else '' }}" required>
      </div>

      <div class="col-md-6">
        <label class="form-label">Accesorios</label>
        <input class="form-control" name="accesorios" value="{{ order.accesorios if order else '' }}" placeholder="Funda, vidrio, SIM, etc.">
      </div>

      <!-- PATR√ìN / PIN -->
      <div class="col-md-4">
        <label class="form-label d-block">
          Clave / Patr√≥n (PIN o patr√≥n) <span class="text-danger">*</span>
        </label>

        <div class="mb-2">
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="tipo_clave" id="tipo_pin" value="pin" checked>
            <label class="form-check-label" for="tipo_pin">PIN</label>
          </div>
          <div class="form-check form-check-inline">
            <input class="form-check-input" type="radio" name="tipo_clave" id="tipo_patron" value="patron">
            <label class="form-check-label" for="tipo_patron">Patr√≥n</label>
          </div>
        </div>

        <input
          class="form-control mb-2"
          name="clave_desbloqueo"
          id="clave_desbloqueo"
          value="{{ order.clave_desbloqueo if order else '' }}"
          placeholder="Ej: 1234 o 1-2-5-8"
          required
        >

        <div id="patternLock" class="border rounded p-2"></div>

        <button type="button" id="btnClearPattern" class="btn btn-sm btn-outline-secondary mt-2">
          Borrar patr√≥n
        </button>

        <div class="form-text">
          Dibuj√° un patr√≥n (3√ó3). Se guarda como secuencia (ej: 1-2-5-8).
        </div>
      </div>

      <!-- COSTOS NUM√âRICOS -->
      <div class="col-md-4">
        <label class="form-label">Costo estimado (AR$)</label>
        <input
          class="form-control"
          id="costo_estimado"
          name="costo_estimado"
          value="{{ order.costo_estimado if order and order.costo_estimado is not none else '' }}"
          inputmode="decimal"
          pattern="\\d+(\\.\\d{1,2})?"
          title="Solo n√∫meros o decimales"
        >
      </div>

      <div class="col-md-4">
        <label class="form-label">Se√±a (AR$)</label>
        <input
          class="form-control"
          id="senia"
          name="senia"
          value="{{ order.senia if order else '' }}"
          inputmode="decimal"
          pattern="\\d+(\\.\\d{1,2})?"
          title="Solo n√∫meros o decimales"
        >
      </div>

      <!-- PROBLEMA REPORTADO -->
      <div class="col-md-12">
        <label class="form-label">Problema reportado *</label>
        <textarea class="form-control" name="problema_reportado" id="problema_reportado" rows="2" required>{{ order.problema_reportado if order else '' }}</textarea>
      </div>

      <!-- DIAGNOSTICO -->
      <div class="col-md-12">
        <label class="form-label">Diagn√≥stico</label>
        <textarea class="form-control" name="diagnostico" rows="2">{{ order.diagnostico if order else '' }}</textarea>
      </div>

    </div>

    <div class="mt-3">
      <button id="btnGuardar" class="btn btn-primary">Guardar</button>
      <a class="btn btn-outline-secondary" href="{{ url_for('orders_list') }}">Cancelar</a>
    </div>
  </form>
</div>

<!-- MODAL B√öSQUEDA DE CLIENTES -->
<div class="modal fade" id="clientModal" tabindex="-1" aria-labelledby="clientModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="clientModalLabel">Buscar cliente</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div class="flex-grow-1 me-3">
            <input
              type="text"
              id="clientSearch"
              class="form-control"
              placeholder="Buscar por nombre, tel√©fono o email..."
            >
          </div>
          <div>
            <label class="me-1 small">Registros por p√°gina:</label>
            <select id="clientPageSize" class="form-select form-select-sm" style="width:auto; display:inline-block;">
              <option value="10">10</option>
              <option value="25">25</option>
              <option value="50">50</option>
            </select>
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-sm table-hover align-middle mb-0">
            <thead>
              <tr>
                <th>Nombre</th>
                <th>Tel√©fono</th>
                <th>Email</th>
                <th style="width: 90px;">Acci√≥n</th>
              </tr>
            </thead>
            <tbody id="clientTableBody">
              <!-- relleno por JS -->
            </tbody>
          </table>
        </div>
      </div>
      <div class="modal-footer justify-content-between">
        <div class="small text-muted" id="clientPageInfo"></div>
        <div>
          <button type="button" class="btn btn-sm btn-outline-secondary me-1" id="clientPrevPage">Anterior</button>
          <button type="button" class="btn btn-sm btn-outline-secondary" id="clientNextPage">Siguiente</button>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  /* Contenedor del patr√≥n */
  #patternLock {
    width: 260px;
    height: 260px;
    margin-top: 8px;
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    grid-template-rows: repeat(3, 1fr);
    justify-items: center;
    align-items: center;
    position: relative;
    transition: opacity 0.15s;
  }

  .pattern-dot {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    border: 3px solid #0d6efd;
    background: #fff;
    box-sizing: border-box;
    position: relative;
    transition: background-color 0.15s, border-color 0.15s;
  }

  .pattern-dot.active {
    background-color: #0d6efd;
  }

  #patternLock svg {
    position: absolute;
    top: 0;
    left: 0;
    pointer-events: none;
  }

  .pattern-line {
    stroke: #0d6efd;
    stroke-width: 4;
    stroke-linecap: round;
  }

  #patternLock.disabled {
    opacity: 0.35;
    pointer-events: none;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // === VALIDACIONES NUM√âRICAS ===
    const imei = document.getElementById('imei');
    const costo = document.getElementById('costo_estimado');
    const senia = document.getElementById('senia');

    if (imei) {
      imei.addEventListener('input', function (e) {
        e.target.value = e.target.value.replace(/\D/g, '').slice(0, 15);
      });
    }

    function limpiarDecimal(el) {
      if (!el) return;
      let v = el.value.replace(/[^0-9.,]/g, '');
      v = v.replace(',', '.');
      const partes = v.split('.');
      if (partes.length > 2) {
        v = partes[0] + '.' + partes.slice(1).join('');
      }
      el.value = v;
    }

    if (costo) costo.addEventListener('input', () => limpiarDecimal(costo));
    if (senia) senia.addEventListener('input', () => limpiarDecimal(senia));

    // === PATR√ìN 3x3 CASERO ===
    const container = document.getElementById('patternLock');
    const inputClave = document.getElementById('clave_desbloqueo');
    const form = document.getElementById('orderForm');
    const radioPin = document.getElementById('tipo_pin');
    const radioPatron = document.getElementById('tipo_patron');
    const btnClearPattern = document.getElementById('btnClearPattern');

    if (!container || !inputClave || !form) return;

    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    svg.setAttribute('width', '100%');
    svg.setAttribute('height', '100%');
    container.appendChild(svg);

    const dots = [];
    for (let i = 0; i < 9; i++) {
      const dot = document.createElement('div');
      dot.className = 'pattern-dot';
      dot.dataset.index = String(i + 1);
      container.appendChild(dot);
      dots.push(dot);
    }

    let pattern = [];
    let isDrawing = false;
    let lastDot = null;

    function getCenter(el) {
      const rect = el.getBoundingClientRect();
      const parentRect = container.getBoundingClientRect();
      return {
        x: rect.left + rect.width / 2 - parentRect.left,
        y: rect.top + rect.height / 2 - parentRect.top
      };
    }

    function addDot(dot) {
      const idx = dot.dataset.index;
      if (!idx || pattern.includes(idx)) return;

      dot.classList.add('active');

      if (lastDot) {
        const p1 = getCenter(lastDot);
        const p2 = getCenter(dot);
        const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        line.setAttribute('x1', p1.x);
        line.setAttribute('y1', p1.y);
        line.setAttribute('x2', p2.x);
        line.setAttribute('y2', p2.y);
        line.classList.add('pattern-line');
        svg.appendChild(line);
      }

      lastDot = dot;
      pattern.push(idx);
      inputClave.value = pattern.join('-');
    }

    function resetPattern() {
      pattern = [];
      lastDot = null;
      dots.forEach(d => d.classList.remove('active'));
      while (svg.firstChild) svg.removeChild(svg.firstChild);
      if (radioPatron.checked) {
        inputClave.value = '';
      }
    }

    function startDrawing(dot) {
      if (!radioPatron.checked) return;
      resetPattern();
      isDrawing = true;
      addDot(dot);
    }

    function stopDrawing() {
      isDrawing = false;
    }

    dots.forEach(dot => {
      dot.addEventListener('mousedown', function (e) {
        e.preventDefault();
        startDrawing(dot);
      });

      dot.addEventListener('mouseenter', function () {
        if (!isDrawing) return;
        addDot(dot);
      });
    });

    document.addEventListener('mouseup', function () {
      if (isDrawing) stopDrawing();
    });

    container.addEventListener('touchstart', function (e) {
      e.preventDefault();
      if (!radioPatron.checked) return;
      const touch = e.touches[0];
      const el = document.elementFromPoint(touch.clientX, touch.clientY);
      if (el && el.classList.contains('pattern-dot')) startDrawing(el);
    }, { passive: false });

    container.addEventListener('touchmove', function (e) {
      e.preventDefault();
      if (!isDrawing || !radioPatron.checked) return;
      const touch = e.touches[0];
      const el = document.elementFromPoint(touch.clientX, touch.clientY);
      if (el && el.classList.contains('pattern-dot')) addDot(el);
    }, { passive: false });

    container.addEventListener('touchend', function () {
      if (isDrawing) stopDrawing();
    });

    if (btnClearPattern) {
      btnClearPattern.addEventListener('click', function () {
        resetPattern();
      });
    }

    function aplicarModoClave() {
      if (radioPin.checked) {
        container.classList.add('disabled');
        inputClave.readOnly = false;
      } else {
        container.classList.remove('disabled');
        inputClave.readOnly = true;
        resetPattern();
      }
    }

    if (radioPin && radioPatron) {
      radioPin.addEventListener('change', aplicarModoClave);
      radioPatron.addEventListener('change', aplicarModoClave);
      aplicarModoClave();
    }

    form.addEventListener('submit', function (e) {
      const claveVal = (inputClave.value || '').trim();

      if (radioPatron.checked) {
        if (pattern.length === 0) {
          e.preventDefault();
          alert('Deb√©s dibujar un patr√≥n antes de guardar la orden.');
          return;
        }
      } else {
        if (claveVal === '') {
          e.preventDefault();
          alert('Deb√©s ingresar un PIN antes de guardar la orden.');
          return;
        }
      }
    });

    // === MODAL DE CLIENTES: B√öSQUEDA + PAGINACI√ìN ===
    const clientSelect = document.getElementById('client_id');
    const clientModalEl = document.getElementById('clientModal');
    const clientSearch = document.getElementById('clientSearch');
    const clientPageSizeSelect = document.getElementById('clientPageSize');
    const clientTableBody = document.getElementById('clientTableBody');
    const clientPageInfo = document.getElementById('clientPageInfo');
    const clientPrevPageBtn = document.getElementById('clientPrevPage');
    const clientNextPageBtn = document.getElementById('clientNextPage');

    if (clientModalEl && clientSearch && clientPageSizeSelect && clientTableBody) {
      const clientsData = [
        {% for c in clients %}
        {
          id: {{ c.id }},
          nombre: {{ c.nombre|tojson }},
          telefono: {{ (c.telefono or '')|tojson }},
          email: {{ (c.email or '')|tojson }}
        }{% if not loop.last %},{% endif %}
        {% endfor %}
      ];

      let filteredClients = clientsData.slice();
      let currentPage = 1;
      let pageSize = parseInt(clientPageSizeSelect.value, 10) || 10;

      function applyFilter() {
        const q = (clientSearch.value || '').toLowerCase();
        filteredClients = clientsData.filter(c => {
          const texto = (c.nombre + ' ' + (c.telefono || '') + ' ' + (c.email || '')).toLowerCase();
          return texto.includes(q);
        });
        currentPage = 1;
        renderClientTable();
      }

      function renderClientTable() {
        const total = filteredClients.length;
        const totalPages = Math.max(1, Math.ceil(total / pageSize));
        if (currentPage > totalPages) currentPage = totalPages;

        const start = (currentPage - 1) * pageSize;
        const end = start + pageSize;
        const pageItems = filteredClients.slice(start, end);

        clientTableBody.innerHTML = '';

        if (pageItems.length === 0) {
          const tr = document.createElement('tr');
          const td = document.createElement('td');
          td.colSpan = 4;
          td.className = 'text-center text-muted';
          td.textContent = 'No se encontraron clientes.';
          tr.appendChild(td);
          clientTableBody.appendChild(tr);
        } else {
          pageItems.forEach(c => {
            const tr = document.createElement('tr');

            const tdNombre = document.createElement('td');
            tdNombre.textContent = c.nombre;
            tr.appendChild(tdNombre);

            const tdTel = document.createElement('td');
            tdTel.textContent = c.telefono || '';
            tr.appendChild(tdTel);

            const tdEmail = document.createElement('td');
            tdEmail.textContent = c.email || '';
            tr.appendChild(tdEmail);

            const tdAccion = document.createElement('td');
            const btnSel = document.createElement('button');
            btnSel.type = 'button';
            btnSel.className = 'btn btn-sm btn-primary';
            btnSel.textContent = 'Seleccionar';
            btnSel.dataset.clientId = c.id;
            tdAccion.appendChild(btnSel);
            tr.appendChild(tdAccion);

            clientTableBody.appendChild(tr);
          });
        }

        clientPageInfo.textContent = `P√°gina ${currentPage} de ${Math.max(1, totalPages)} ‚Äì ${total} cliente(s)`;
        clientPrevPageBtn.disabled = currentPage <= 1;
        clientNextPageBtn.disabled = currentPage >= totalPages;
      }

      clientSearch.addEventListener('input', applyFilter);

      clientPageSizeSelect.addEventListener('change', function () {
        pageSize = parseInt(this.value, 10) || 10;
        currentPage = 1;
        renderClientTable();
      });

      clientPrevPageBtn.addEventListener('click', function () {
        if (currentPage > 1) {
          currentPage--;
          renderClientTable();
        }
      });

      clientNextPageBtn.addEventListener('click', function () {
        const totalPages = Math.max(1, Math.ceil(filteredClients.length / pageSize));
        if (currentPage < totalPages) {
          currentPage++;
          renderClientTable();
        }
      });

      clientTableBody.addEventListener('click', function (e) {
        const btn = e.target.closest('button[data-client-id]');
        if (!btn) return;
        const id = btn.dataset.clientId;
        if (clientSelect && id) {
          clientSelect.value = id;
        }
        if (window.bootstrap) {
          const modalInstance = bootstrap.Modal.getInstance(clientModalEl) || new bootstrap.Modal(clientModalEl);
          modalInstance.hide();
        }
      });

      clientModalEl.addEventListener('shown.bs.modal', function () {
        clientSearch.value = '';
        filteredClients = clientsData.slice();
        currentPage = 1;
        renderClientTable();
        clientSearch.focus();
      });
    }
  });
</script>

{% endblock %}
