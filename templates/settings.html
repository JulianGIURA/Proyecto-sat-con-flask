{% extends "base.html" %}
{% block content %}
<div class="container py-4" style="max-width:860px;">
  <h4>Configuración</h4>

  <form id="settingsForm" method="post" enctype="multipart/form-data" novalidate>
    <div class="row g-3">

      <!-- Empresa -->
      <div class="col-md-6">
        <label class="form-label">Nombre de la empresa <span class="text-danger">*</span></label>
        <input
          class="form-control"
          id="empresa"
          name="empresa"
          value="{{ s.empresa }}"
          required
        >
        <div id="empresaError" class="form-text text-danger d-none"></div>
      </div>

      <!-- Teléfono -->
      <div class="col-md-3">
        <label class="form-label">Teléfono / WhatsApp <span class="text-danger">*</span></label>
        <input
          class="form-control"
          id="telefono"
          name="telefono"
          value="{{ s.telefono }}"
          required
          inputmode="tel"
        >
        <div id="telefonoError" class="form-text text-danger d-none"></div>
      </div>

      <!-- Email -->
      <div class="col-md-3">
        <label class="form-label">Email <span class="text-danger">*</span></label>
        <input
          class="form-control"
          id="email"
          name="email"
          value="{{ s.email }}"
          required
          type="email"
        >
        <div id="emailError" class="form-text text-danger d-none"></div>
      </div>

      <!-- Dirección -->
      <div class="col-md-12">
        <label class="form-label">Dirección</label>
        <input class="form-control" name="direccion" value="{{ s.direccion }}">
      </div>

      <!-- Garantías y condiciones -->
      <div class="col-md-12">
        <label class="form-label">Garantías / Condiciones (aparecen en ticket y PDF)</label>
        <textarea
          class="form-control"
          name="condiciones"
          rows="4"
          placeholder="Ejemplo:
- Garantía de 90 días sobre la reparación.
- No cubre golpes, humedad ni daños por mal uso.
- Es obligatorio presentar el ticket para hacer valer la garantía."
        >{{ s.condiciones }}</textarea>
      </div>

      <!-- Logo -->
      <div class="col-md-6">
        <label class="form-label">Logo (PNG/JPG, máx 4MB)</label>
        <input
          class="form-control"
          type="file"
          name="logo"
          accept=".png,.jpg,.jpeg"
        >
        <div class="form-text">
          Formatos permitidos: PNG, JPG o JPEG. Tamaño máximo: 4MB.
        </div>
      </div>

      <div class="col-md-6 d-flex align-items-end">
        {% if s.logo_filename %}
          <img src="{{ url_for('static', filename='uploads/' + s.logo_filename) }}" alt="logo" style="height:64px">
        {% else %}
          <span class="text-muted">Sin logo cargado</span>
        {% endif %}
      </div>
    </div>

    <div class="mt-3">
      <button id="btnGuardar" class="btn btn-primary" disabled>Guardar</button>
    </div>
  </form>
</div>

<style>
.is-valid { border: 2px solid #28a745 !important; }
.is-invalid { border: 2px solid #dc3545 !important; }
</style>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const form       = document.getElementById('settingsForm');
  const empresa    = document.getElementById('empresa');
  const telefono   = document.getElementById('telefono');
  const email      = document.getElementById('email');
  const btnGuardar = document.getElementById('btnGuardar');

  const empresaError  = document.getElementById('empresaError');
  const telefonoError = document.getElementById('telefonoError');
  const emailError    = document.getElementById('emailError');

  function marcar(input, ok) {
    input.classList.remove("is-valid", "is-invalid");
    if (input.value.trim() === "") {
      // Sin clases si está vacío (para que no se vea rojo desde el inicio)
      return;
    }
    input.classList.add(ok ? "is-valid" : "is-invalid");
  }

  function validar() {
    const empresaVal = empresa.value.trim();
    const telVal     = telefono.value.trim();
    const emailVal   = email.value.trim();

    // Empresa: obligatorio
    const empresaOk = empresaVal.length > 0;

    // Teléfono: permitimos espacios, +, guiones, paréntesis;
    // condición real: al menos 6 dígitos en total
    const soloDigitos = telVal.replace(/\D/g, '');
    const telOk = soloDigitos.length >= 6;

    // Email: patrón simple tipo texto@texto.texto
    const emailOk = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailVal);

    // Marcar visualmente
    marcar(empresa, empresaOk);
    marcar(telefono, telOk);
    marcar(email, emailOk);

    // Mensajes de error
    if (!empresaOk) {
      empresaError.textContent = "Ingresá el nombre de la empresa.";
      empresaError.classList.remove("d-none");
    } else {
      empresaError.textContent = "";
      empresaError.classList.add("d-none");
    }

    if (!telOk) {
      telefonoError.textContent = "Ingresá un teléfono válido (mínimo 6 dígitos). Ej: 2616744195 o +54 9 261 123 4567.";
      telefonoError.classList.remove("d-none");
    } else {
      telefonoError.textContent = "";
      telefonoError.classList.add("d-none");
    }

    if (!emailOk) {
      emailError.textContent = "Ingresá un correo válido. Ej: celulares.st.mendoza@gmail.com";
      emailError.classList.remove("d-none");
    } else {
      emailError.textContent = "";
      emailError.classList.add("d-none");
    }

    const todoOk = empresaOk && telOk && emailOk;
    btnGuardar.disabled = !todoOk;

    return todoOk;
  }

  empresa.addEventListener('input', validar);
  telefono.addEventListener('input', validar);
  email.addEventListener('input', validar);

  // Validar una vez al cargar, por si ya hay datos
  validar();

  form.addEventListener('submit', function (e) {
    if (!validar()) {
      e.preventDefault();
    }
  });
});
</script>

{% endblock %}
