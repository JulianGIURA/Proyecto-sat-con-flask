{% extends "base.html" %}
{% set orden_cerrada = order.estado in ['Entregado', 'Cancelado', 'entregado', 'cancelado'] %}
{% block content %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center">
    <h4>Orden #{{ order.id }}</h4>
    <div class="btn-group">
      {# Editar deshabilitado si la orden está cerrada #}
      {% if orden_cerrada %}
        <button class="btn btn-outline-secondary" disabled>Editar</button>
      {% else %}
        <a class="btn btn-outline-secondary" href="{{ url_for('order_edit_form', order_id=order.id) }}">Editar</a>
      {% endif %}
      <a class="btn btn-outline-primary" href="{{ url_for('order_ticket', order_id=order.id) }}" target="_blank">Ticket</a>
      <a class="btn btn-outline-success" href="{{ url_for('order_pdf', order_id=order.id) }}">PDF para cliente</a>
      <a class="btn btn-outline-dark" href="{{ public_url }}" target="_blank">Link público</a>
      <a class="btn btn-success" href="{{ wa_link }}" target="_blank">Compartir WhatsApp</a>
      <a class="btn btn-outline-secondary" href="{{ url_for('orders_list') }}">Volver</a>
    </div>
  </div>

  {# Banner informativo cuando la orden está cerrada #}
  {% if orden_cerrada %}
  <div class="alert alert-warning mt-3" role="alert">
    <strong>ORDEN CERRADA.</strong>
    Estado actual:
    <span class="badge text-bg-secondary text-uppercase">{{ order.estado_label() }}</span>.
    No es posible modificar repuestos ni cambiar el estado.
  </div>
  {% endif %}

  <div class="row g-3 mt-1">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header">Cliente</div>
        <div class="card-body">
          <div><strong>{{ order.client.nombre }}</strong></div>
          <div class="text-muted">{{ order.client.telefono }} · {{ order.client.email }}</div>
          <div class="text-muted">{{ order.client.direccion }}</div>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>Equipo</span>
          <img src="{{ url_for('order_qr_png', order_id=order.id) }}" alt="QR" style="height:64px">
        </div>
        <div class="card-body">
          <div><strong>{{ order.marca }} {{ order.modelo }}</strong></div>
          <div>IMEI: {{ order.imei or '—' }}</div>
          <div>Accesorios: {{ order.accesorios or '—' }}</div>
          <div>Clave/Patrón: <code>{{ order.clave_desbloqueo or '—' }}</code></div>
        </div>
      </div>
    </div>

    <div class="col-md-12">
      <div class="card">
        <div class="card-header">Diagnóstico y costos</div>
        <div class="card-body">
          <div><strong>Problema reportado:</strong> {{ order.problema_reportado }}</div>
          <div><strong>Diagnóstico:</strong> {{ order.diagnostico or '—' }}</div>
          <div class="mt-2">
            <strong>Costo estimado:</strong>
            {{ ('AR$ %.2f' % order.costo_estimado) if order.costo_estimado is not none else '—' }}
            ·
            <strong>Seña:</strong>
            {{ ('AR$ %.2f' % order.senia) if order.senia else '—' }}
          </div>
        </div>
      </div>
    </div>

    <!-- Repuestos internos -->
    <div class="col-md-12">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>Repuestos (interno)</span>
          <span class="text-muted">Total: <strong>AR$ {{ '%.2f' % total_repuestos }}</strong></span>
        </div>
        <div class="card-body">
          <form class="row g-2" method="post" action="{{ url_for('add_part', order_id=order.id) }}">
            <div class="col-md-6">
              <input
                class="form-control"
                name="descripcion"
                placeholder="Descripción del repuesto"
                {% if orden_cerrada %}readonly{% endif %}
              >
            </div>
            <div class="col-md-3">
              <input
                class="form-control"
                name="costo"
                id="repuesto_costo"
                placeholder="Costo (AR$)"
                inputmode="decimal"
                {% if orden_cerrada %}readonly{% endif %}
              >
            </div>
            <div class="col-md-3">
              <button class="btn btn-primary w-100" {% if orden_cerrada %}disabled{% endif %}>Agregar</button>
            </div>
          </form>
          <div class="table-responsive mt-3">
            <table class="table table-sm">
              <thead><tr><th>#</th><th>Descripción</th><th>Costo</th><th></th></tr></thead>
              <tbody>
                {% for p in order.repuestos %}
                <tr>
                  <td>{{ p.id }}</td>
                  <td>{{ p.descripcion }}</td>
                  <td>AR$ {{ '%.2f' % p.costo }}</td>
                  <td>
                    {% if orden_cerrada %}
                      <button class="btn btn-sm btn-outline-danger" disabled>Eliminar</button>
                    {% else %}
                      <form method="post" action="{{ url_for('del_part', order_id=order.id, part_id=p.id) }}" onsubmit="return confirm('¿Eliminar repuesto?')">
                        <button class="btn btn-sm btn-outline-danger">Eliminar</button>
                      </form>
                    {% endif %}
                  </td>
                </tr>
                {% else %}
                <tr><td colspan="4" class="text-muted">Sin repuestos cargados</td></tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-12">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span>Estado actual: <span class="badge text-bg-primary">{{ order.estado_label() }}</span></span>
          <small class="text-muted">Actualizado: {{ order.updated_at.strftime("%d/%m/%Y %H:%M") }}</small>
        </div>
        <div class="card-body">
          <form method="post" action="{{ url_for('order_change_status', order_id=order.id) }}" class="row g-2 align-items-end">
            <div class="col-md-4">
              <label class="form-label">Nuevo estado</label>
              <select class="form-select" name="estado" {% if orden_cerrada %}disabled{% endif %}>
                {% for val, label in estados %}
                  <option value="{{ val }}" {% if order.estado==val %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-6">
              <label class="form-label">Nota</label>
              <input
                class="form-control"
                name="nota"
                placeholder="Ej: se pide repuesto, cliente avisado, etc."
                {% if orden_cerrada %}readonly{% endif %}
              >
            </div>
            <div class="col-md-2">
              <button class="btn btn-primary w-100" {% if orden_cerrada %}disabled{% endif %}>Actualizar</button>
            </div>
          </form>
        </div>
        <ul class="list-group list-group-flush">
          {% for h in order.historial %}
          <li class="list-group-item d-flex justify-content-between">
            <div>
              <strong>{{ dict(estados).get(h.estado, h.estado) }}</strong>
              <div class="text-muted small">{{ h.nota or '' }}</div>
            </div>
            <span class="text-muted small">{{ h.created_at.strftime("%d/%m/%Y %H:%M") }}</span>
          </li>
          {% else %}
          <li class="list-group-item text-muted">Sin historial</li>
          {% endfor %}
        </ul>
      </div>
    </div>
  </div>
</div>

<style>
  /* Inputs readonly y selects disabled se ven "normales" pero no editables */
  input[readonly],
  textarea[readonly] {
    background-color: #ffffff !important;
    opacity: 1 !important;
    cursor: not-allowed;
  }

  select:disabled {
    background-color: #ffffff !important;
    opacity: 1 !important;
    cursor: not-allowed;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const costoInput = document.getElementById('repuesto_costo');
    if (!costoInput) return;

    costoInput.addEventListener('input', function (e) {
      // Permite solo dígitos, coma y punto. Normaliza coma a punto y deja solo un decimal.
      let v = e.target.value.replace(/[^0-9.,]/g, '');
      v = v.replace(',', '.');
      const partes = v.split('.');
      if (partes.length > 2) {
        v = partes[0] + '.' + partes.slice(1).join('');
      }
      e.target.value = v;
    });
  });
</script>
{% endblock %}
